# Build Pipeline - Continuous Integration (Linux)
# Builds .NET Core 8 API + React TypeScript UI

stages:
- stage: Build
  displayName: 'Build and Test Application'
  
  variables:
    buildConfiguration: 'Release'
    dotnetVersion: '8.0.x'
    nodeVersion: '18.x'
    apiPath: 'SchoolManagement.API'
    uiPath: 'SchoolManagement.UI'
  
  jobs:
  ###########################################
  # Job 1: Build .NET Core 8 API
  ###########################################
  - job: BuildAPI
    displayName: 'Build .NET Core 8 API'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    # Install .NET Core SDK
    - task: UseDotNet@2
      displayName: 'Install .NET Core SDK $(dotnetVersion)'
      inputs:
        version: $(dotnetVersion)
        packageType: sdk
    
    # Display .NET version
    - bash: |
        dotnet --version
        dotnet --list-sdks
      displayName: 'Display .NET Version'
    
    # Restore NuGet packages
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: '$(apiPath)/**/*.csproj'
        feedsToUse: 'select'
    
    # Build API
    - task: DotNetCoreCLI@2
      displayName: 'Build API Project'
      inputs:
        command: 'build'
        projects: '$(apiPath)/**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'
    
    # Run Unit Tests (if test project exists)
    - task: DotNetCoreCLI@2
      displayName: 'Run API Unit Tests'
      inputs:
        command: 'test'
        projects: '**/*Tests/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx --results-directory $(Agent.TempDirectory)/TestResults'
        publishTestResults: false
      continueOnError: true
      condition: succeededOrFailed()
    
    # Publish Test Results
    - task: PublishTestResults@2
      displayName: 'Publish API Test Results'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: 'API Tests'
      condition: succeededOrFailed()
    
    # Publish Code Coverage
    - task: PublishCodeCoverageResults@2
      displayName: 'Publish API Code Coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml'
        failIfCoverageEmpty: false
      condition: succeededOrFailed()
    
    # Publish API
    - task: DotNetCoreCLI@2
      displayName: 'Publish API'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '$(apiPath)/**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/api --no-restore'
        zipAfterPublish: true
        modifyOutputPath: false
    
    # List published files
    - bash: |
        echo "Published API files:"
        ls -lah $(Build.ArtifactStagingDirectory)/api
      displayName: 'List Published API Files'
    
    # Publish API Artifacts
    - task: PublishBuildArtifacts@1
      displayName: 'Publish API Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/api'
        ArtifactName: 'api-drop'
        publishLocation: 'Container'
  
  ###########################################
  # Job 2: Build React TypeScript UI
  ###########################################
  - job: BuildUI
    displayName: 'Build React TypeScript UI'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    # Install Node.js
    - task: NodeTool@0
      displayName: 'Install Node.js $(nodeVersion)'
      inputs:
        versionSpec: $(nodeVersion)
    
    # Display Node and npm versions
    - bash: |
        node --version
        npm --version
        echo "Current directory: $(pwd)"
        echo "UI Path will be: $(Build.SourcesDirectory)/$(uiPath)"
      displayName: 'Display Node.js and npm versions'
    
    # Debug - Check if UI path exists
    - bash: |
        echo "=== Checking UI Directory ==="
        if [ -d "$(uiPath)" ]; then
          echo "‚úÖ UI directory found"
          echo "Contents:"
          ls -la $(uiPath)
          echo ""
          echo "package.json exists:"
          ls -la $(uiPath)/package.json
        else
          echo "‚ùå UI directory not found at: $(uiPath)"
          echo "Repository structure:"
          ls -la
          exit 1
        fi
      displayName: 'Verify UI Directory'
    
    # Cache npm packages
    - task: Cache@2
      displayName: 'Cache npm packages'
      inputs:
        key: 'npm | "$(Agent.OS)" | $(uiPath)/package-lock.json'
        path: '$(uiPath)/node_modules'
        restoreKeys: |
          npm | "$(Agent.OS)"
        cacheHitVar: 'CACHE_RESTORED'
    
    # Install dependencies
    - bash: |
        cd $(uiPath)
        echo "Installing npm dependencies..."
        
        # Check if node_modules exists and cache was restored
        if [ -d "node_modules" ] && [ "$(CACHE_RESTORED)" = "true" ]; then
          echo "‚úÖ Using cached node_modules"
        else
          echo "üì¶ Installing fresh dependencies..."
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps
        fi
        
        echo "‚úÖ Dependencies installed"
      displayName: 'Install UI Dependencies'
    
    # Run ESLint with better error handling
    - bash: |
        cd $(uiPath)
        echo "Running ESLint..."
        npm run lint || echo "‚ö†Ô∏è ESLint found issues (non-blocking)"
      displayName: 'Run ESLint'
      continueOnError: true
    
    # Run TypeScript compiler check
    - bash: |
        cd $(uiPath)
        echo "Running TypeScript type check..."
        npx tsc --noEmit || echo "‚ö†Ô∏è TypeScript errors found (non-blocking)"
      displayName: 'TypeScript Type Check'
      continueOnError: true
    
    # Run UI Tests (with fallback if no tests exist)
    - bash: |
        cd $(uiPath)
        echo "Running UI tests..."
        
        # Check if test script exists
        if npm run | grep -q "test"; then
          npm test -- --coverage --watchAll=false --ci --passWithNoTests --reporters=default --reporters=jest-junit || echo "‚ö†Ô∏è Tests failed (non-blocking)"
        else
          echo "‚ö†Ô∏è No test script found in package.json - skipping tests"
        fi
      displayName: 'Run UI Tests'
      continueOnError: true
      env:
        CI: true
    
    # Publish UI Test Results
    - task: PublishTestResults@2
      displayName: 'Publish UI Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(uiPath)/junit.xml'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: 'UI Tests'
      condition: succeededOrFailed()
      continueOnError: true
    
    # Publish UI Code Coverage
    - task: PublishCodeCoverageResults@2
      displayName: 'Publish UI Code Coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(uiPath)/coverage/cobertura-coverage.xml'
        reportDirectory: '$(uiPath)/coverage'
        failIfCoverageEmpty: false
      condition: succeededOrFailed()
      continueOnError: true
    
    # Build React Application with memory optimization
    - bash: |
        cd $(uiPath)
        echo "Building React application..."
        
        # Set Node memory limit
        export NODE_OPTIONS="--max_old_space_size=8192"
        
        # Build with error handling
        npm run build
        
        BUILD_EXIT_CODE=$?
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "‚ùå Build failed with exit code: $BUILD_EXIT_CODE"
          exit $BUILD_EXIT_CODE
        fi
        
        echo "‚úÖ Build completed successfully"
      displayName: 'Build React UI'
      env:
        CI: false
        GENERATE_SOURCEMAP: false
        TSC_COMPILE_ON_ERROR: true
    
    # Verify and normalize build output
    - bash: |
        cd $(uiPath)
        echo "Verifying build output..."
        
        # Check for build or dist directory (CRA vs Vite)
        if [ -d "build" ]; then
          echo "‚úÖ Found 'build' directory (Create React App)"
          BUILD_DIR="build"
        elif [ -d "dist" ]; then
          echo "‚úÖ Found 'dist' directory (Vite) - renaming to 'build'"
          mv dist build
          BUILD_DIR="build"
        else
          echo "‚ùå No build output found!"
          echo "Directory contents:"
          ls -la
          exit 1
        fi
        
        echo ""
        echo "Build output contents:"
        ls -lah $BUILD_DIR
        
        # Verify index.html exists
        if [ ! -f "$BUILD_DIR/index.html" ]; then
          echo "‚ùå index.html not found in build output!"
          exit 1
        fi
        
        echo "‚úÖ Build output verified successfully"
      displayName: 'Verify Build Output'
    
    # Copy build files
    - task: CopyFiles@2
      displayName: 'Copy UI Build Files'
      inputs:
        SourceFolder: '$(uiPath)/build'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/ui'
        CleanTargetFolder: true
    
    # List build files
    - bash: |
        echo "UI Build files in staging directory:"
        ls -lah $(Build.ArtifactStagingDirectory)/ui
        echo ""
        echo "File count:"
        find $(Build.ArtifactStagingDirectory)/ui -type f | wc -l
      displayName: 'List UI Build Files'
    
    # Archive UI Build
    - task: ArchiveFiles@2
      displayName: 'Archive UI Build'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/ui'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/ui-build.zip'
        replaceExistingArchive: true
    
    # Verify archive was created
    - bash: |
        echo "Verifying archive..."
        if [ -f "$(Build.ArtifactStagingDirectory)/ui-build.zip" ]; then
          echo "‚úÖ Archive created successfully"
          ls -lh $(Build.ArtifactStagingDirectory)/ui-build.zip
        else
          echo "‚ùå Archive not found!"
          exit 1
        fi
      displayName: 'Verify Archive'
    
    # Publish UI Artifacts
    - task: PublishBuildArtifacts@1
      displayName: 'Publish UI Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/ui-build.zip'
        ArtifactName: 'ui-drop'
        publishLocation: 'Container'
  
  ###########################################
  # Job 3: Build Summary
  ###########################################
  - job: BuildSummary
    displayName: 'Build Summary'
    dependsOn:
    - BuildAPI
    - BuildUI
    condition: succeededOrFailed()
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - bash: |
        echo "========================================"
        echo "Build Summary"
        echo "========================================"
        echo "Build Number: $(Build.BuildNumber)"
        echo "Source Branch: $(Build.SourceBranchName)"
        echo "Build Configuration: $(buildConfiguration)"
        echo "Trigger: $(Build.Reason)"
        echo ""
        echo "Job Status:"
        echo "  - API Build: ${{ dependencies.BuildAPI.result }}"
        echo "  - UI Build: ${{ dependencies.BuildUI.result }}"
        echo "========================================"
      displayName: 'Display Build Summary'
