name: Build-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - master

pr:
  branches:
    include:
      - main
      - master

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  nodeVersion: '20.x'
  apiPath: 'SchoolManagement.API'
  uiPath: 'SchoolManagement.UI'

stages:
  - stage: Build
    displayName: 'Build and Test Application'
    jobs:
      - job: BuildAPI
        displayName: 'Build .NET Core 8 API'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET Core SDK $(dotnetVersion)'
            inputs:
              version: $(dotnetVersion)
              packageType: sdk
          
          - bash: |
              dotnet --version
              dotnet --list-sdks
            displayName: 'Display .NET Version'
          
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: '$(apiPath)/**/*.csproj'
              feedsToUse: 'select'
          
          - task: DotNetCoreCLI@2
            displayName: 'Build API Project'
            inputs:
              command: 'build'
              projects: '$(apiPath)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'
          
          - task: DotNetCoreCLI@2
            displayName: 'Run API Unit Tests'
            inputs:
              command: 'test'
              projects: '**/*Tests/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx --results-directory $(Agent.TempDirectory)/TestResults'
              publishTestResults: false
            continueOnError: true
            condition: succeededOrFailed()
          
          - task: PublishTestResults@2
            displayName: 'Publish API Test Results'
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'API Tests'
            condition: succeededOrFailed()
          
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish API Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml'
              failIfCoverageEmpty: false
            condition: succeededOrFailed()
          
          - task: DotNetCoreCLI@2
            displayName: 'Publish API'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(apiPath)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/api --no-restore'
              zipAfterPublish: true
              modifyOutputPath: false
          
          - bash: |
              echo "Published API files:"
              ls -lah $(Build.ArtifactStagingDirectory)/api
            displayName: 'List Published API Files'
          
          - publish: $(Build.ArtifactStagingDirectory)/api
            artifact: api-drop
            displayName: 'Publish API Artifacts'
      
      - job: BuildUI
        displayName: 'Build React TypeScript UI'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)
          
          - bash: |
              node --version
              npm --version
            displayName: 'Display Node.js and npm versions'
          
          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(uiPath)/package-lock.json'
              path: '$(uiPath)/node_modules'
              restoreKeys: |
                npm | "$(Agent.OS)"
              cacheHitVar: 'CACHE_RESTORED'
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              echo "Installing dependencies..."
              npm ci --prefer-offline
            displayName: 'Install UI Dependencies'
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              if grep -q '"lint"' package.json; then
                npm run lint
              else
                echo "##[warning]No lint script found - skipping"
              fi
            displayName: 'Run ESLint'
            continueOnError: true
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              npx tsc --noEmit
            displayName: 'TypeScript Type Check'
            continueOnError: true
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              if grep -q '"test"' package.json; then
                echo "Running tests..."
                npm test -- --coverage --watchAll=false --ci --reporters=default --reporters=jest-junit || true
              else
                echo "##[warning]No test script found in package.json - skipping tests"
              fi
            displayName: 'Run UI Tests'
            continueOnError: true
            condition: succeededOrFailed()
            env:
              CI: true
          
          - task: PublishTestResults@2
            displayName: 'Publish UI Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(Build.SourcesDirectory)/$(uiPath)/junit.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'UI Tests'
            continueOnError: true
            condition: succeededOrFailed()
          
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish UI Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Build.SourcesDirectory)/$(uiPath)/coverage/cobertura-coverage.xml'
              reportDirectory: '$(Build.SourcesDirectory)/$(uiPath)/coverage'
              failIfCoverageEmpty: false
            continueOnError: true
            condition: succeededOrFailed()
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              echo "Current directory: $(pwd)"
              echo "================================"
              echo "Running npm run build..."
              npm run build
              
              echo "Checking for output folders..."
              if [ -d "build" ]; then
                echo "##vso[task.setvariable variable=buildOutputFolder]build"
                echo "? Found 'build' folder (Create React App)"
                ls -lah build/ | head -20
              elif [ -d "dist" ]; then
                echo "##vso[task.setvariable variable=buildOutputFolder]dist"
                echo "? Found 'dist' folder (Vite)"
                ls -lah dist/ | head -20
              else
                echo "##[error]No build output folder found!"
                ls -lah
                exit 1
              fi
            displayName: 'Build React UI'
            env:
              CI: false
              GENERATE_SOURCEMAP: false
              NODE_ENV: production
          
          - task: ArchiveFiles@2
            displayName: 'Archive UI Build'
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)/$(uiPath)/$(buildOutputFolder)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/ui-build.zip'
              replaceExistingArchive: true
          
          - bash: |
              echo "UI Build archive:"
              ls -lah $(Build.ArtifactStagingDirectory)
            displayName: 'List UI Build Files'
          
          - publish: $(Build.ArtifactStagingDirectory)/ui-build.zip
            artifact: ui-drop
            displayName: 'Publish UI Artifacts'
      
      - job: BuildSummary
        displayName: 'Build Summary'
        dependsOn:
          - BuildAPI
          - BuildUI
        condition: succeededOrFailed()
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - bash: |
              echo "========================================"
              echo "Build Summary"
              echo "========================================"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Source Branch: $(Build.SourceBranchName)"
              echo "Build Configuration: $(buildConfiguration)"
              echo "========================================"
            displayName: 'Display Build Summary'