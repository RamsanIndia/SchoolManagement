name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - master

variables:
  - group: school-app-variables
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetVersion
    value: '8.0.x'
  - name: nodeVersion
    value: '20.x'
  - name: apiPath
    value: 'SchoolManagement.API'
  - name: uiPath
    value: 'SchoolManagement.UI'

stages:
  ###########################################
  # STAGE 1: BUILD
  ###########################################
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildAPI
        displayName: 'Build .NET Core 8 API'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET Core SDK $(dotnetVersion)'
            inputs:
              version: $(dotnetVersion)
              packageType: sdk
          
          - bash: |
              dotnet --version
              dotnet --list-sdks
            displayName: 'Display .NET Version'
          
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: '$(apiPath)/**/*.csproj'
              feedsToUse: 'select'
          
          - task: DotNetCoreCLI@2
            displayName: 'Build API Project'
            inputs:
              command: 'build'
              projects: '$(apiPath)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'
          
          - task: DotNetCoreCLI@2
            displayName: 'Run API Unit Tests'
            inputs:
              command: 'test'
              projects: '**/*Tests/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx --results-directory $(Agent.TempDirectory)/TestResults'
              publishTestResults: false
            continueOnError: true
            condition: succeededOrFailed()
          
          - task: PublishTestResults@2
            displayName: 'Publish API Test Results'
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'API Tests'
            condition: succeededOrFailed()
          
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish API Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml'
              failIfCoverageEmpty: false
            condition: succeededOrFailed()
          
          - task: DotNetCoreCLI@2
            displayName: 'Publish API'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(apiPath)/**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/api --no-restore'
              zipAfterPublish: true
              modifyOutputPath: false
          
          - publish: $(Build.ArtifactStagingDirectory)/api
            artifact: api-drop
            displayName: 'Publish API Artifacts'
      
      - job: BuildUI
        displayName: 'Build React TypeScript UI'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)
          
          - bash: |
              node --version
              npm --version
            displayName: 'Display Node.js and npm versions'
          
          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | $(uiPath)/package-lock.json'
              path: '$(uiPath)/node_modules'
              restoreKeys: |
                npm | "$(Agent.OS)"
              cacheHitVar: 'CACHE_RESTORED'
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              echo "Installing dependencies..."
              npm ci --prefer-offline
            displayName: 'Install UI Dependencies'
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              if grep -q '"lint"' package.json; then
                npm run lint
              else
                echo "##[warning]No lint script found - skipping"
              fi
            displayName: 'Run ESLint'
            continueOnError: true
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              npx tsc --noEmit
            displayName: 'TypeScript Type Check'
            continueOnError: true
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              if grep -q '"test"' package.json; then
                echo "Running tests..."
                npm test -- --coverage --watchAll=false --ci --reporters=default --reporters=jest-junit || true
              else
                echo "##[warning]No test script found in package.json - skipping tests"
              fi
            displayName: 'Run UI Tests'
            continueOnError: true
            condition: succeededOrFailed()
            env:
              CI: true
          
          - task: PublishTestResults@2
            displayName: 'Publish UI Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(Build.SourcesDirectory)/$(uiPath)/junit.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'UI Tests'
            continueOnError: true
            condition: succeededOrFailed()
          
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish UI Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Build.SourcesDirectory)/$(uiPath)/coverage/cobertura-coverage.xml'
              reportDirectory: '$(Build.SourcesDirectory)/$(uiPath)/coverage'
              failIfCoverageEmpty: false
            continueOnError: true
            condition: succeededOrFailed()
          
          - bash: |
              cd $(Build.SourcesDirectory)/$(uiPath)
              echo "Running npm run build..."
              npm run build
              
              echo "Checking for output folders..."
              if [ -d "build" ]; then
                echo "##vso[task.setvariable variable=buildOutputFolder]build"
                echo "✓ Found 'build' folder (Create React App)"
                ls -lah build/ | head -20
              elif [ -d "dist" ]; then
                echo "##vso[task.setvariable variable=buildOutputFolder]dist"
                echo "✓ Found 'dist' folder (Vite)"
                ls -lah dist/ | head -20
              else
                echo "##[error]No build output folder found!"
                ls -lah
                exit 1
              fi
            displayName: 'Build React UI'
            env:
              CI: false
              GENERATE_SOURCEMAP: false
              NODE_ENV: production
          
          - task: ArchiveFiles@2
            displayName: 'Archive UI Build'
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)/$(uiPath)/$(buildOutputFolder)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/ui-build.zip'
              replaceExistingArchive: true
          
          - publish: $(Build.ArtifactStagingDirectory)/ui-build.zip
            artifact: ui-drop
            displayName: 'Publish UI Artifacts'

  ###########################################
  # STAGE 2: DEPLOY TO DEVELOPMENT
  ###########################################
  - stage: DeployDevelopment
    displayName: 'Deploy to Development'
    dependsOn: Build
    condition: succeeded()  # Always deploy to dev after successful build
    variables:
      - name: apiWebAppName
        value: $(DEV_API_WEBAPP_NAME)
      - name: uiWebAppName
        value: $(DEV_UI_WEBAPP_NAME)
      - name: resourceGroup
        value: $(DEV_RESOURCE_GROUP)
      - name: databaseServer
        value: $(DEV_DATABASE_SERVER)
      - name: dbUsername
        value: $(DEV_DB_USERNAME)
      - name: dbPassword
        value: $(DEV_DB_PASSWORD)
      - name: appInsightsConnectionString
        value: $(DEV_APPINSIGHTS_CONNECTION_STRING)
      - name: aspnetEnvironment
        value: 'Development'
    
    jobs:
      - deployment: DeployDevAPI
        displayName: 'Deploy API to Development'
        environment: 'development'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: api-drop
                  displayName: 'Download API Artifacts'
                
                - task: AzureRmWebAppDeployment@4
                  displayName: 'Deploy API to Azure App Service'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appType: 'webAppLinux'
                    WebAppName: '$(apiWebAppName)'
                    packageForLinux: '$(Pipeline.Workspace)/api-drop/**/*.zip'
                    RuntimeStack: 'DOTNETCORE|8.0'
                
                - task: AzureAppServiceSettings@1
                  displayName: 'Configure API App Settings'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appName: '$(apiWebAppName)'
                    resourceGroupName: '$(resourceGroup)'
                    appSettings: |
                      [
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "$(aspnetEnvironment)",
                          "slotSetting": false
                        },
                        {
                          "name": "ConnectionStrings__DefaultConnection",
                          "value": "Server=$(databaseServer).database.windows.net;Database=SchoolDB;User Id=$(dbUsername);Password=$(dbPassword);",
                          "slotSetting": false
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "value": "$(appInsightsConnectionString)",
                          "slotSetting": false
                        },
                        {
                          "name": "AllowedOrigins",
                          "value": "https://$(uiWebAppName).azurewebsites.net",
                          "slotSetting": false
                        }
                      ]
                
                - bash: |
                    echo "Waiting 45 seconds for API to fully start..."
                    sleep 45
                  displayName: 'Wait for API to Start'
                
                - task: AzureCLI@2
                  displayName: 'Check App Service Status'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Checking App Service status..."
                      az webapp show \
                        --name $(apiWebAppName) \
                        --resource-group $(resourceGroup) \
                        --query "{name:name, state:state, hostNames:defaultHostName}" \
                        -o table
                      
                      STATE=$(az webapp show \
                        --name $(apiWebAppName) \
                        --resource-group $(resourceGroup) \
                        --query "state" -o tsv)
                      
                      echo "App State: $STATE"
                      
                      if [ "$STATE" != "Running" ]; then
                        echo "⚠️ Warning: App is not in Running state!"
                      else
                        echo "✅ App is running"
                      fi
                  continueOnError: true
                
                - bash: |
                    echo "========================================"
                    echo "API Health Check - Detailed Diagnostics"
                    echo "========================================"
                    
                    API_URL="https://$(apiWebAppName).azurewebsites.net"
                    HEALTH_URL="$API_URL/health"
                    
                    echo "API URL: $API_URL"
                    echo "Health Endpoint: $HEALTH_URL"
                    echo ""
                    
                    # Check if app is accessible at root
                    echo "1. Testing root endpoint..."
                    ROOT_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 $API_URL)
                    echo "   Root status code: $ROOT_CODE"
                    
                    if [ "$ROOT_CODE" = "000" ]; then
                      echo "   ❌ Cannot connect to API at all!"
                      echo "   This usually means:"
                      echo "   - App failed to start"
                      echo "   - Wrong app name"
                      echo "   - Deployment failed"
                      echo ""
                      echo "2. Checking Azure App Service status..."
                      echo "   Please check in Azure Portal if the app is running"
                      exit 1
                    fi
                    
                    echo "   ✅ API is accessible (Status: $ROOT_CODE)"
                    echo ""
                    
                    # Try health endpoint
                    echo "2. Testing /health endpoint..."
                    sleep 15
                    
                    MAX_ATTEMPTS=5
                    ATTEMPT=1
                    
                    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
                      echo "   Attempt $ATTEMPT/$MAX_ATTEMPTS..."
                      
                      HEALTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 $HEALTH_URL)
                      
                      if [ $HEALTH_CODE -eq 200 ]; then
                        echo "   ✅ Health check passed!"
                        RESPONSE=$(curl -s $HEALTH_URL)
                        echo "   Response: $RESPONSE"
                        exit 0
                      fi
                      
                      echo "   ⚠️ Health endpoint returned: $HEALTH_CODE"
                      
                      if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                        echo "   Waiting 15 seconds..."
                        sleep 15
                      fi
                      
                      ATTEMPT=$((ATTEMPT + 1))
                    done
                    
                    echo ""
                    echo "⚠️ Health endpoint not responding with 200"
                    echo "Possible reasons:"
                    echo "- /health endpoint doesn't exist in your API"
                    echo "- API is running but health check not configured"
                    echo "- App is still initializing"
                    echo ""
                    echo "✅ API root is accessible, continuing anyway..."
                    exit 0
                  displayName: 'API Health Check'
                  continueOnError: true
      
      - deployment: DeployDevUI
        displayName: 'Deploy UI to Development'
        dependsOn: DeployDevAPI
        condition: succeeded()
        environment: 'development'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: ui-drop
                  displayName: 'Download UI Artifacts'
                
                - task: ExtractFiles@1
                  displayName: 'Extract UI Build'
                  inputs:
                    archiveFilePatterns: '$(Pipeline.Workspace)/ui-drop/ui-build.zip'
                    destinationFolder: '$(Pipeline.Workspace)/ui-extracted'
                    cleanDestinationFolder: true
                
                - task: AzureRmWebAppDeployment@4
                  displayName: 'Deploy UI to Azure App Service'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appType: 'webAppLinux'
                    WebAppName: '$(uiWebAppName)'
                    packageForLinux: '$(Pipeline.Workspace)/ui-extracted'
                    RuntimeStack: 'NODE|18-lts'
                
                - task: AzureAppServiceSettings@1
                  displayName: 'Configure UI App Settings'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appName: '$(uiWebAppName)'
                    resourceGroupName: '$(resourceGroup)'
                    appSettings: |
                      [
                        {
                          "name": "REACT_APP_API_URL",
                          "value": "https://$(apiWebAppName).azurewebsites.net",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITE_NODE_DEFAULT_VERSION",
                          "value": "~18",
                          "slotSetting": false
                        }
                      ]
                
                - bash: |
                    echo "✅ Development Deployment Complete!"
                    echo "API: https://$(apiWebAppName).azurewebsites.net"
                    echo "UI: https://$(uiWebAppName).azurewebsites.net"
                  displayName: 'Deployment Summary'

  ###########################################
  # STAGE 3: DEPLOY TO PRODUCTION
  ###########################################
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployDevelopment  # Deploy to prod after dev succeeds
    condition: succeeded()  # Can add manual approval in Environments settings
    variables:
      - name: apiWebAppName
        value: $(PROD_API_WEBAPP_NAME)
      - name: uiWebAppName
        value: $(PROD_UI_WEBAPP_NAME)
      - name: resourceGroup
        value: $(PROD_RESOURCE_GROUP)
      - name: databaseServer
        value: $(PROD_DATABASE_SERVER)
      - name: dbUsername
        value: $(PROD_DB_USERNAME)
      - name: dbPassword
        value: $(PROD_DB_PASSWORD)
      - name: appInsightsConnectionString
        value: $(PROD_APPINSIGHTS_CONNECTION_STRING)
      - name: storageAccount
        value: $(PROD_STORAGE_ACCOUNT)
      - name: storageKey
        value: $(PROD_STORAGE_KEY)
      - name: aspnetEnvironment
        value: 'Production'
    
    jobs:
      - deployment: DeployProdAPI
        displayName: 'Deploy API to Production'
        environment: 'production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            preDeploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Backup Production Database'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      DATE=$(date +%Y%m%d_%H%M%S)
                      BACKUP_NAME="api_backup_$DATE"
                      echo "Creating database backup: $BACKUP_NAME"
                      az sql db export \
                        --resource-group $(resourceGroup) \
                        --server $(databaseServer) \
                        --name SchoolDB \
                        --admin-user $(dbUsername) \
                        --admin-password $(dbPassword) \
                        --storage-key-type StorageAccessKey \
                        --storage-key $(storageKey) \
                        --storage-uri "https://$(storageAccount).blob.core.windows.net/backups/$BACKUP_NAME.bacpac" \
                      && echo "✅ Backup completed" \
                      || echo "⚠️ Backup failed, continuing..."
                  continueOnError: true
            
            deploy:
              steps:
                - download: current
                  artifact: api-drop
                  displayName: 'Download API Artifacts'
                
                - task: AzureRmWebAppDeployment@4
                  displayName: 'Deploy API to Azure App Service'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appType: 'webAppLinux'
                    WebAppName: '$(apiWebAppName)'
                    packageForLinux: '$(Pipeline.Workspace)/api-drop/**/*.zip'
                    RuntimeStack: 'DOTNETCORE|8.0'
                
                - task: AzureAppServiceSettings@1
                  displayName: 'Configure API App Settings'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appName: '$(apiWebAppName)'
                    resourceGroupName: '$(resourceGroup)'
                    appSettings: |
                      [
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "$(aspnetEnvironment)",
                          "slotSetting": false
                        },
                        {
                          "name": "ConnectionStrings__DefaultConnection",
                          "value": "Server=$(databaseServer).database.windows.net;Database=SchoolDB;User Id=$(dbUsername);Password=$(dbPassword);",
                          "slotSetting": false
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "value": "$(appInsightsConnectionString)",
                          "slotSetting": false
                        },
                        {
                          "name": "AllowedOrigins",
                          "value": "https://$(uiWebAppName).azurewebsites.net",
                          "slotSetting": false
                        }
                      ]
                
                - bash: |
                    echo "========================================"
                    echo "Production API Health Check"
                    echo "========================================"
                    
                    API_URL="https://$(apiWebAppName).azurewebsites.net"
                    HEALTH_URL="$API_URL/health"
                    
                    echo "Testing: $HEALTH_URL"
                    sleep 30
                    
                    MAX_ATTEMPTS=10
                    ATTEMPT=1
                    
                    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
                      echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
                      
                      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 $HEALTH_URL)
                      
                      if [ "$HTTP_CODE" = "000" ]; then
                        # Check root endpoint
                        ROOT_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 $API_URL)
                        if [ "$ROOT_CODE" != "000" ]; then
                          echo "⚠️ API is running but /health endpoint not available"
                          echo "Root endpoint status: $ROOT_CODE"
                          echo "✅ Continuing since API is accessible"
                          exit 0
                        fi
                      fi
                      
                      if [ $HTTP_CODE -eq 200 ]; then
                        echo "✅ API Health Check Passed!"
                        RESPONSE=$(curl -s $HEALTH_URL)
                        echo "Response: $RESPONSE"
                        exit 0
                      fi
                      
                      echo "⚠️ Status: $HTTP_CODE"
                      
                      if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                        echo "Waiting 10 seconds..."
                        sleep 10
                      fi
                      
                      ATTEMPT=$((ATTEMPT + 1))
                    done
                    
                    echo "❌ API Health Check Failed after $MAX_ATTEMPTS attempts!"
                    exit 1
                  displayName: 'API Health Check'
      
      - deployment: DeployProdUI
        displayName: 'Deploy UI to Production'
        dependsOn: DeployProdAPI
        condition: succeeded()
        environment: 'production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: ui-drop
                  displayName: 'Download UI Artifacts'
                
                - task: ExtractFiles@1
                  displayName: 'Extract UI Build'
                  inputs:
                    archiveFilePatterns: '$(Pipeline.Workspace)/ui-drop/ui-build.zip'
                    destinationFolder: '$(Pipeline.Workspace)/ui-extracted'
                    cleanDestinationFolder: true
                
                - task: AzureRmWebAppDeployment@4
                  displayName: 'Deploy UI to Azure App Service'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appType: 'webAppLinux'
                    WebAppName: '$(uiWebAppName)'
                    packageForLinux: '$(Pipeline.Workspace)/ui-extracted'
                    RuntimeStack: 'NODE|18-lts'
                
                - task: AzureAppServiceSettings@1
                  displayName: 'Configure UI App Settings'
                  inputs:
                    azureSubscription: 'Azure-School-Management'
                    appName: '$(uiWebAppName)'
                    resourceGroupName: '$(resourceGroup)'
                    appSettings: |
                      [
                        {
                          "name": "REACT_APP_API_URL",
                          "value": "https://$(apiWebAppName).azurewebsites.net",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITE_NODE_DEFAULT_VERSION",
                          "value": "~18",
                          "slotSetting": false
                        }
                      ]
                
                - bash: |
                    sleep 20
                    UI_URL="https://$(uiWebAppName).azurewebsites.net"
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $UI_URL)
                    if [ $HTTP_CODE -eq 200 ]; then
                      echo "✅ UI is accessible!"
                    else
                      echo "⚠️ UI returned status: $HTTP_CODE"
                    fi
                  displayName: 'UI Smoke Test'
                
                - bash: |
                    echo "========================================"
                    echo "✅ PRODUCTION DEPLOYMENT COMPLETE!"
                    echo "========================================"
                    echo "API: https://$(apiWebAppName).azurewebsites.net"
                    echo "UI: https://$(uiWebAppName).azurewebsites.net"
                    echo "========================================"
                  displayName: 'Deployment Summary'